# 轻量级呼吸预测方案

## 软硬件选择
编程语言：Python 用于开发可训练深度学习模型TransRR和用Tkinter库设计前端展示界面。 
硬件：微型计算机Jetson Nano；Arduino 开发板；Pulse Sensor光电反射式脉搏传感器(PS-XX)；ADS1292R三导联心电传感器(导联线，电极贴片）。 

## 数据收集
把pulsesensor和ads1292R的测量代码烧录到arduino中，pulsesensor和ads1292R传感器通过spi通信分别将心电和脉搏信号传输给arduino，arduino再与上位机nano进行串口通信输入心电和脉搏信号，并绘制ecg和ppg图像，然后通过在nano中训练的TransRR模型预测呼吸频率，最终通过wifi模块把数据传输到数据库中。

## RR预测方法研究
尽管基于深度学习的模型大大提高了医学任务的准确性，其实际临床应用仍面临严重的泛化能力挑战。首先，ECG、PPG信号形态易受采集设备、生理状态、年龄等因素的影响，如老年人群自主神经调节功能衰减导致信号特征变异，而不同医疗机构的操作规范差异进一步加剧数据分布偏移。其次，现有公开数据集仅涵盖数百名受试者，模型易陷入对有限样本的过拟合，难以捕获普适性特征。更严重的是，多数研究采用受试者内分段验证策略，致使模型在新个体上的预测可靠性非常差。为此，本章提出TransRR模型，这是一种面向跨域泛化的RR预测Transformer架构。通过引入受试者间z-score标准化与变分模态分解有效消除个体生理差异和设备噪声干扰。实验采用混合数据集训练机制和受试者层级的十折交叉验证，严格评估模型在新个体与新采集环境下的泛化性能。Transformer 模型为自然语言处理领域的进步做出了重大贡献，并在时间数据处理中得到了广泛的应用。本项目改进了其编码器的结构，使更加适应RR预测问题。TransRR的架构由三个模块组成：输入模块、Transformer 模块和输出模块。

## 数据处理
步骤： 
（1） 将医疗仪器采集到的心电信号（ECG）和光电容积脉搏波信号（PPG）重采样到125Hz，并将文件保存为csv格式。 
（2）使用3阶巴特沃斯带通滤波器过滤掉ECG、PPG信号中不属于呼吸频率的信号，带通滤波器截至频率为0.1，0.6。 
（3）使用变分模态VMD分解删除两种信号的最后一种模态，保留剩余信号。变分模态分解则认为信号是由不同频率占优的子信号叠加而成的，其目的是要把信号分解成不同频率的子信号。 
（4）将两种信号进行z-score归一化。由于不同受试者之间心电信号和光电容积脉搏波信号差异较大，Z-Score的主要目的将不同量级的数据统一转化为同一个量级，并使用统一计算出的Z-Score值进行衡量，以保证数据之间的可比性。 
（5）将信号截断为每16s一个窗口。 
（6）移除呼吸频率大于等于30和呼吸频率小于等于5的样本，理论上这些样本为异常呼吸频率。 
（7）将长度为16s的信号段输入TransRR模型中进行呼吸频率预测。 
最后，植入进nano的TransRR深度学习模型将对nano接受的数据进行处理并预测，最终得到预测的呼吸频率。

## 模型训练
软件部分利用了Transformer模型并改进其编码器设计，使其更适合呼吸频率预测问题，最终形成了 TransRR模型。TransRR的架构由三个模块组成：输入模块、Transformer模块和输出模块。
输入模块负责处理输入的可接受信号，接收信号为长度250（16 s）的心电信号（ECG）和光电容积脉搏波（PPG）信号（八分之一倍下采样后）。然后两种信号被送入位置编码器(Positional Encoding)。该编码器通过频率变化的正弦和余弦函数实现心电信号（ECG）和光电容积脉搏波（PPG）信号的位置编码，确保Transformer模块能够理解信号中的时间和空间关系。随后，带有位置信息的ECG和PPG信号被连接成一个250×2矩阵（Concatenate）。最终该矩阵作为Transformer模块的输入。 
Transformer模块是TransRR模型的核心。该模块基于Transformer的编码器，增强了两种类型的inception块：卷积核inception和扩张inception。TransRR最初采用多头自注意力机制来识别信号内部的关系（头大小=32，头的数量=8）。该过程的输出随后通过残差连接与Transformer模块的输入相加，随后进行层归一化处理。规范化后的嵌入接下来被引导进入一个卷积核inception块，通过不同尺寸的卷积核（核大小=3、5、7、9）捕获各种局部特征。为了捕获更大感受野中的信息并进一步整合多尺度上下文信息，采用了扩张inception块，其扩张率为1、4、8和16（卷积核大小=5）。这两种inception块之后分别跟随着一个dropout层和一个1D CNN层，以防止过拟合并调整通道数。最后，再次实现了一个残差连接和层归一化。在TransRR模型中，将四个Transformer模块被堆叠在一起，以进一步加强特征的编码和表示。 
输出模块用于将编码后的特征映射到RR间期的预测值。这些特征首先被展平成一个向量，然后通过深度神经网络（DNN）块进行处理。该模块包括四个全连接层，每个层后面都有随机失活层（Dropout），这有助于防止模型过度拟合数据。这些全连接层的神经元数量经过精心配置，以确保模型能够捕捉到特定特征的抽象表示，最终的全连接层输出就是RR间期的预测值。

## 图形界面
图形界面主要用于可视化数据，分为主界面和检测界面，主界面分为“首页”，“检测”，“数据”，“文档”四个模块，“检测”界面能够完整地检测数据并绘制ecg，ppg波形，其余模块尚未补充完整。

## 说明
本项目技术方面沿用当今热门的深度学习模型和嵌入式模块。应用方面注重于当下海上所重点关注的医疗健康。该系统完成的主要功能有三点： 
（1）针对现有方法存在的低精度、跨域性能较差的问题，搭建了以Transformer为核心的TransRR模型。在跨受试者的交叉验证中，TransRR在MAE等多个指标上优于现有其它模型。 
（2）结合ADS1292R心电传感器和Pulse Sensor脉搏传感器，通过Arduino Uno开发板实现生理信号的高效采集与传输。把心电、脉搏信号采集到nano平台中并进行处理。 
（3）优化TransRR模型大小，把模型转移到nano中，采用Python开发语言与进行实时信号采集与展示，并利用提出的TransRR模型进行RR预测。
